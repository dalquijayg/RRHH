<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Planilla Tiempo Parcial - Recursos Humanos</title>
    <link rel="stylesheet" href="../Disenos/Planilla/PlanillaTiempoParcial.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.0.19/sweetalert2.min.js"></script>
    
    <style>
        /* ===== ESTILOS ADICIONALES PARA SCROLL Y BOTONES VISIBLES ===== */
        
        /* Contenedor principal de la sección de planilla */
        .payroll-section {
            background: white;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-large);
            border: 1px solid var(--gray-200);
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            /* NUEVO: Altura máxima para forzar scroll interno */
            max-height: calc(100vh - 120px);
        }

        /* Header de la sección (fijo en la parte superior) */
        .payroll-section .section-header {
            background: linear-gradient(135deg, var(--trust-navy) 0%, var(--trust-blue) 50%, var(--trust-slate) 100%);
            color: white;
            padding: var(--spacing-xl) var(--spacing-2xl);
            position: relative;
            overflow: hidden;
            flex-shrink: 0; /* No se comprime */
            z-index: 10;
        }

        /* NUEVO: Área de contenido scrolleable */
        .payroll-content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        /* Contenedor de la tabla con scroll mejorado */
        .payroll-table-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            background: white;
            min-height: 0;
            /* NUEVO: Altura máxima específica */
            max-height: calc(100vh - 320px);
            /* NUEVO: Borde superior sutil para separar del header */
            border-top: 1px solid var(--gray-100);
        }

        /* NUEVO: Contenedor de acciones mejorado - siempre visible */
        .payroll-actions-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-lg);
            padding: var(--spacing-lg) var(--spacing-xl);
            background: linear-gradient(135deg, var(--gray-25) 0%, var(--gray-50) 100%);
            border-top: 1px solid var(--gray-200);
            flex-shrink: 0; /* IMPORTANTE: No se comprime */
            position: sticky;
            bottom: 0;
            z-index: 5;
            /* NUEVO: Sombra sutil hacia arriba */
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
        }

        /* Estados vacíos mejorados */
        .empty-payroll-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-2xl);
            min-height: 200px; /* Altura mínima reducida */
            background: linear-gradient(135deg, var(--gray-25) 0%, white 100%);
        }

        /* Indicador de scroll */
        .scroll-indicator {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            animation: bounce 2s infinite;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
            60% {
                transform: translateY(-3px);
            }
        }

        /* RESPONSIVE: En pantallas pequeñas */
        @media (max-width: 1024px) {
            .payroll-table-container {
                max-height: calc(100vh - 400px);
            }
            
            .payroll-actions-container {
                flex-direction: column;
                gap: var(--spacing-md);
                padding: var(--spacing-md);
            }
            
            .right-summary {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .payroll-table-container {
                max-height: calc(100vh - 350px);
            }
            
            .payroll-actions-container {
                padding: var(--spacing-sm);
            }
            
            .left-actions {
                flex-direction: column;
                width: 100%;
                gap: var(--spacing-xs);
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header Principal -->
    <header class="main-header">
        <div class="header-container">
            <!-- Columna izquierda: Logo y título -->
            <div class="header-brand">
                <img src="../Imagenes/Logo Recursos Humanos new.png" alt="Logo RRHH" class="header-logo">
                <div class="header-info">
                    <div class="title-container">
                        <h1>Planilla Tiempo Parcial</h1>
                        <div class="planilla-info" id="planillaInfo" style="display: none;">
                            <span class="planilla-badge clickeable" id="planillaBadge" onclick="cambiarConfiguracionDesdeHeader()" title="Click para cambiar configuración">
                                Información de Planilla
                            </span>
                        </div>
                    </div>
                    <p>Gestión de pagos para colaboradores</p>
                </div>
            </div>
            
            <!-- Columna central: Información del departamento (se genera dinámicamente) -->
            <div class="header-center">
                <!-- Se llena automáticamente con JavaScript -->
            </div>
            
            <button type="button" id="btnAyuda" class="btn-help" title="Ayuda del sistema">
                <i class="fas fa-question-circle"></i>
                <span>Ayuda</span>
            </button>
        </div>
    </header>

    <!-- Nuevo: Selección de Tipo de Planilla -->
    <section class="payroll-type-section config-centered">
    <div class="payroll-type-container">
        <div class="payroll-type-header enhanced">
            <h2><i class="fas fa-cog"></i> Configuración de Planilla</h2>
            <p>Configure el tipo y período de la planilla antes de gestionar colaboradores</p>
        </div>
        
        <div class="payroll-type-form" id="payrollTypeForm">
            <div class="form-row enhanced">
                <div class="form-group enhanced">
                    <label for="fechaInicio">📅 Fecha Inicio</label>
                    <input type="date" id="fechaInicio" class="form-control enhanced">
                </div>
                
                <div class="form-group enhanced">
                    <label for="fechaFin">📅 Fecha Fin</label>
                    <input type="date" id="fechaFin" class="form-control enhanced">
                </div>
                
                <!-- BOTONES MEJORADOS LADO A LADO -->
                <div class="form-group enhanced buttons-group">
                    <div class="config-buttons-container">
                        <button type="button" id="confirmarPlanilla" class="btn-config btn-config-primary" disabled>
                            <i class="fas fa-rocket"></i>
                            <span>¡Iniciar!</span>
                        </button>
                        
                        <button type="button" id="descargarPDF" class="btn-config btn-config-secondary" style="display: none;">
                            <i class="fas fa-file-pdf"></i>
                            <span>PDF</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Información actualizada -->
            <div class="config-info">
                <div style="display: grid; grid-template-columns: 1fr; gap: var(--spacing-sm);">
                    <div class="info-card">
                        <h4 style="color: var(--trust-blue); margin-bottom: var(--spacing-xs); display: flex; align-items: center; gap: var(--spacing-xs);">
                            <i class="fas fa-calendar-alt"></i>
                            Período Personalizado
                        </h4>
                        <p>Seleccione las fechas de <strong>inicio y fin</strong> para el período de pago</p>
                    </div>
                </div>
                
                <div class="info-important">
                    <p>
                        <i class="fas fa-info-circle"></i>
                        <strong>Importante:</strong> Solo se podrán asignar turnos dentro del período seleccionado.
                    </p>
                </div>
            </div>
        </div>

        <!-- Vista confirmada actualizada -->
        <div class="payroll-confirmed enhanced" id="payrollConfirmed" style="display: none;">
            <div class="confirmed-info" style="background: linear-gradient(135deg, var(--success-emerald) 0%, var(--success-light) 100%); color: white; padding: var(--spacing-lg); border-radius: var(--radius-lg); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-medium);">
                <div class="confirmed-details">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
                        <i class="fas fa-check-circle" style="font-size: 1.2rem;"></i>
                        <span class="confirmed-type" id="confirmedType" style="font-size: 1rem; font-weight: 700;">Período Configurado</span>
                    </div>
                    <span class="confirmed-period" id="confirmedPeriod" style="font-size: 0.8rem; opacity: 0.9;">Rango de fechas</span>
                </div>
                <button type="button" id="changePlanilla" class="btn-change" style="background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.5); color: white; padding: var(--spacing-xs) var(--spacing-md); border-radius: var(--radius-md); font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px);">
                    <i class="fas fa-edit"></i>
                    Cambiar
                </button>
            </div>
        </div>
    </div>
</section>

    <!-- Contenedor Principal -->
    <main class="main-container">
        <!-- Panel Izquierdo: Lista de Colaboradores -->
        <section class="left-panel">
            <!-- Lista de Colaboradores -->
            <div class="collaborators-section" id="collaboratorsSection" style="display: none;">
                <div class="section-header">
                    <h3><i class="fas fa-users"></i> Colaboradores</h3>
                    <div class="collaborator-stats">
                        <span class="count-badge" id="collaboratorCount">0</span>
                    </div>
                </div>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchCollaborator" placeholder="Buscar por nombre..." class="search-input">
                </div>
                <div class="collaborators-list" id="collaboratorsList">
                    <!-- Lista de colaboradores se carga dinámicamente -->
                </div>
            </div>
        </section>

        <!-- Panel Derecho: Planilla Principal -->
        <section class="right-panel">
            <!-- Sección Principal de Planilla (MEJORADA CON NUEVA ESTRUCTURA) -->
            <div class="payroll-section" id="payrollSection">
                <!-- Header (se mantiene igual) -->
                <div class="section-header">
                    <h3><i class="fas fa-file-invoice-dollar"></i> Planilla de Colaboradores</h3>
                    <div class="payroll-stats">
                        <span class="count-badge" id="payrollCount">0</span>
                        <span class="count-label">colaboradores</span>
                    </div>
                </div>

                <!-- NUEVO: Área de contenido scrolleable -->
                <div class="payroll-content-area">
                    <!-- Tabla de colaboradores con scroll propio -->
                    <div class="payroll-table-container" id="payrollTableContainer">
                        <table class="payroll-table" id="payrollTable">
                            <thead>
                                <tr>
                                    <th>Colaborador</th>
                                    <th style="text-align: center;">T. Mañana</th>
                                    <th style="text-align: center;">T. Mixtos</th>
                                    <th style="text-align: center;">T. 4 Horas</th>
                                    <th style="text-align: center;">Total Turnos</th>
                                    <th style="text-align: right;">Total a Pagar</th>
                                    <th style="text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="payrollTableBody">
                                <!-- Filas dinámicas -->
                            </tbody>
                        </table>
                        
                        <!-- Estado vacío -->
                        <div class="empty-payroll-state" id="emptyPayrollState">
                            <div class="empty-state">
                                <i class="fas fa-users-slash"></i>
                                <h4>No hay colaboradores en la planilla</h4>
                                <p>Selecciona un colaborador, asigna turnos y agrégalo a la planilla para comenzar.</p>
                            </div>
                        </div>
                    </div>

                    <!-- NUEVO: Acciones fijas en la parte inferior -->
                    <div class="payroll-actions-container" id="payrollActionsContainer" style="display: none;">
                        <!-- Botones de acción a la izquierda -->
                        <div class="left-actions">
                            <button type="button" id="clearAllPayroll" class="btn btn-danger">
                                <i class="fas fa-trash-alt"></i>
                                <span>Limpiar Planilla</span>
                            </button>
                            
                            <button type="button" id="generateFinalPayroll" class="btn btn-success">
                                <i class="fas fa-file-export"></i>
                                <span>Solicitar Autorización</span>
                            </button>
                        </div>
                        
                        <!-- Resumen total a la derecha -->
                        <div class="right-summary">
                            <div class="compact-total">
                                <div class="compact-total-label">Total General</div>
                                <div class="compact-total-amount" id="totalAmount">Q 0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estado inicial cuando no hay empleado seleccionado -->
            <div class="welcome-state" id="welcomeState">
                <div class="welcome-content">
                    <div class="welcome-icon">
                        <i class="fas fa-user-clock"></i>
                    </div>
                    <h3>Gestión de Planillas</h3>
                    <p>Configure el tipo de planilla y luego seleccione un colaborador para comenzar a gestionar los turnos y generar la planilla de pago.</p>
                    <div class="welcome-steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <span>Configurar planilla</span>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <span>Elegir colaborador</span>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <span>Gestionar turnos</span>
                        </div>
                        <div class="step">
                            <div class="step-number">4</div>
                            <span>Agregar a planilla</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal del Calendario -->
    <div class="modal-overlay" id="calendarModal">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    <h3>Gestión de Turnos</h3>
                </div>
                <div class="modal-employee-info" id="modalEmployeeInfo">
                    <span class="modal-employee-name" id="modalEmployeeName">Empleado</span>
                    <span class="modal-employee-position" id="modalEmployeePosition">Cargo</span>
                </div>
                <button type="button" class="modal-close" id="closeCalendarModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="calendar-section">
                    <div class="calendar-controls">
                        <button type="button" id="prevMonth" class="btn-nav">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h4 id="currentMonth">Mes Año</h4>
                        <button type="button" id="nextMonth" class="btn-nav">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="calendar-container">
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Encabezados de días -->
                            <div class="day-header">Dom</div>
                            <div class="day-header">Lun</div>
                            <div class="day-header">Mar</div>
                            <div class="day-header">Mié</div>
                            <div class="day-header">Jue</div>
                            <div class="day-header">Vie</div>
                            <div class="day-header">Sáb</div>
                            <!-- Días del calendario se generan dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- Panel lateral con resumen y leyendas -->
                <div class="sidebar-section">
                    <!-- Resumen rápido en el modal -->
                    <div class="modal-summary">
                        <h5><i class="fas fa-chart-bar"></i> Resumen Actual</h5>
                        <div class="modal-stats">
                            <div class="modal-stat">
                                <span class="stat-label">Mañana</span>
                                <span class="stat-value" id="modalMorningCount">0</span>
                            </div>
                            <div class="modal-stat">
                                <span class="stat-label">Mixto</span>
                                <span class="stat-value" id="modalMixedCount">0</span>
                            </div>
                            <div class="modal-stat total">
                                <span class="stat-label">Total</span>
                                <span class="stat-value" id="modalTotalCount">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Leyenda del calendario -->
                    <div class="calendar-legend">
                        <div class="legend-section">
                            <h6>Turnos Asignados</h6>
                            <div class="legend-items">
                                <div class="legend-item">
                                    <div style="width: 12px; height: 12px; background: linear-gradient(135deg, #fff7e6, #ffedd5); border: 1px solid #fb923c; border-radius: 3px;"></div>
                                    <span>☀️ Turno Mañana</span>
                                </div>
                                <div class="legend-item">
                                    <div style="width: 12px; height: 12px; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border: 1px solid #6b7280; border-radius: 3px;"></div>
                                    <span>🌙 Turno Mixto</span>
                                </div>
                                <div class="legend-item">
                                    <div style="width: 12px; height: 12px; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 1px solid #22c55e; border-radius: 3px;"></div>
                                    <span>🕐 Turno 4 Horas</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="legend-section">
                            <h6>Disponibilidad</h6>
                            <div class="legend-items">
                                <div class="legend-item">
                                    <div style="width: 12px; height: 12px; background: white; border: 1px solid #d1d5db; border-radius: 3px;"></div>
                                    <span>Disponible</span>
                                </div>
                                <div class="legend-item">
                                    <div style="width: 12px; height: 12px; background: white; border: 1px solid #fbbf24; border-radius: 3px; position: relative;">
                                        <div style="position: absolute; top: 1px; left: 1px; width: 4px; height: 4px; background: #fbbf24; border-radius: 50%;"></div>
                                    </div>
                                    <span>⚠️ Último día disponible</span>
                                </div>
                                <div class="legend-item">
                                    <div style="width: 12px; height: 12px; background: #fef2f2; border: 1px solid #fca5a5; border-radius: 3px; text-decoration: line-through;"></div>
                                    <span>🚫 Semana completa</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="legend-section">
                            <h6>Restricciones</h6>
                            <div class="legend-items">
                                <div class="legend-item sunday-blocked">
                                    <span>🚫 Domingos</span>
                                </div>
                                <div class="legend-item holiday-national">
                                    <span>🇬🇹 Feriados Nacionales</span>
                                </div>
                                <div class="legend-item holiday-departmental">
                                    <span>🏢 Feriados Departamentales</span>
                                </div>
                                <div class="legend-item easter-week">
                                    <span>✝️ Semana Santa</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="legend-info">
                            <i class="fas fa-info-circle"></i>
                            <span>Máximo 4 días por semana</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="clearShiftsFromModal" class="btn btn-secondary">
                    <i class="fas fa-eraser"></i>
                    Limpiar Todo
                </button>
                <button type="button" id="saveAndCloseCalendar" class="btn btn-primary">
                    <i class="fas fa-check"></i>
                    Guardar y Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para selección de turno -->
    <div class="modal-overlay" id="shiftModal">
        <div class="modal-container modal-shift">
            <div class="modal-header">
                <h3>Seleccionar Tipo de Turno</h3>
                <button type="button" class="modal-close" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body modal-shift-body">
                <p class="selected-date-text">
                    <i class="fas fa-calendar-day"></i>
                    <span id="selectedDate">Fecha seleccionada</span>
                </p>
                <div class="shift-options-grid">
                    <button type="button" class="shift-option morning-option" data-shift="1">
                        <div class="option-icon">
                            <i class="fas fa-sun"></i>
                        </div>
                        <div class="option-content">
                            <h4>Turno Mañana</h4>
                            <p>Horario matutino</p>
                        </div>
                    </button>
                    <button type="button" class="shift-option mixed-option" data-shift="2">
                        <div class="option-icon">
                            <i class="fas fa-moon"></i>
                        </div>
                        <div class="option-content">
                            <h4>Turno Mixto</h4>
                            <p>Tarde - Noche</p>
                        </div>
                    </button>
                </div>
                
                <!-- Botón de 4 horas -->
                <div class="shift-option-full">
                    <button type="button" class="shift-option hours-option" data-shift="3">
                        <div class="option-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="option-content">
                            <h4>Turno de 4 Horas</h4>
                            <p>Jornada parcial flexible</p>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../Logica/Planillas/PlanillaTiempoParcial.js"></script>
</body>
</html>